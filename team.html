<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Team</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
      * {
      font-family: 'Georgia', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      font-family: 'Georgia', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding-bottom: 70px;
      background: #f4f4f4;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 45px;
      background-color: #A80D32;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      font-weight: 400;
      z-index: 1000;
    }

    .color-sheet {
      position: relative;
      top: 45px;
      width: 100%;
      height: 140px;
      background-color: #A80D32;
      z-index: 998;
    }

    .income-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 10px;
    }

    .left-column, .right-column {
      width: 48%;
    }

    .income-box {
      background-color: transparent;
      color: white;
      margin-bottom: 10px;
      border-radius: 8px;
      padding: 10px;
    }

    .income-box strong {
      font-size: 16px;
      display: block;
      margin-bottom: 5px;
    }

    .income-box p {
      margin: 0;
      font-size: 14px;
      font-weight: bold;
    }

    .info-card {
      background-color: white;
      margin: 10px;
      margin-top: 60px;
      border-radius: 8px;
      padding: 15px;
    }

    .info-card .hr {
      margin-top: 10px;
    }

    .info-card .highlight {
      font-size: 15px;
      margin-top: 10px;
    }

    .info-card h3 {
      color: #A80D32;
      font-weight: bold;
      margin-top: 0px;
      background-color: #f0fdf4;
      display: inline-block;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .highlight span {
      color: #A80D32;
      font-weight: bold;
    }

    .notification-box {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin: 10px;
      position: relative;
    }

    .notification-image {
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }

    .notification-text {
      background-color: #EEFFEE;
      padding: 10px 15px;
      border-radius: 10px;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }

    .notification-text::before {
      content: '';
      position: absolute;
      top: 50%;
      left: -10px;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 10px solid #EEFFEE;
    }

    .notification-box .highlight {
      color: #A80D32;
      font-weight: bold;
    }

    .notification-box a {
      color: #A80D32;
      text-decoration: none;
      font-weight: bold;
    }

    .whatsapp-button {
      position: fixed;
      bottom: 80px;
      right: 20px;
      -webkit-tap-highlight-color: transparent;
      z-index: 9999;
    }

    .whatsapp-button img {
      width: 50px;
      height: 50px;
      cursor: pointer;
      border-radius: 50%;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #ffffff;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #ddd;
      box-shadow: 0 -2px 6px rgba(1);
      z-index: 1000;
      height: 50px;
    }

    .bottom-nav a {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      color: #777;
      font-size: 12px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .bottom-nav a i {
      display: block;
      font-size: 20px;
      margin-bottom: 2px;
      transition: transform 0.3s;
    }

    .bottom-nav a:hover,
    .bottom-nav a.active {
      color: #A80D32;
      font-weight: bold;
    }

    .bottom-nav a:hover i {
      transform: scale(1.2);
    }

    .info-grid {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .info-grid p {
      width: 48%;
      margin: 5px 0;
      font-size: 14px;
      color: gray;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .info-grid strong {
      font-weight: bold;
      color: black;
    }

    .ref-list {
      background: white;
      margin: 10px;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .ref-list h3 {
      margin-top: 0;
      color: #A80D32;
    }

    .ref-user {
      background: #fff;
      border-radius: 10px;
      padding: 5px 5px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .ref-user .date {
      font-weight: bold;
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
    }

    .ref-user .id {
      font-size: 16px;
      font-weight: bold;
      color: #2d2d2d;
      margin-bottom: 10px;
    }

    .ref-user table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
      font-size: 14px;
    }

    .ref-user th, .ref-user td {
      border: 1px solid #ccc;
      padding: 6px;
    }

    .ref-user th {
      background-color: #d4edda;
      color: #000;
    }

    .tick-circle {
      display: inline-block;
      width: 22px;
      height: 22px;
      background-color: #ccc;
      color: white;
      border-radius: 50%;
      font-weight: bold;
      font-size: 14px;
      line-height: 22px;
    }

    .tick-circle.completed {
      background-color: #A80D32;
    }
  </style>
</head>
<body>

  <header class="header"><h5>Team</h5></header>

  <div class="color-sheet" id="incomeSection">
    <div class="income-row">
      <div class="left-column">
        <div class="income-box"><strong>Total team bonus</strong><p id="totalIncome">Rs 0</p></div>
        <div class="income-box"><strong>Link shear bonus</strong><p id="adIncome">Rs 0</p></div>
      </div>
      <div class="right-column">
        <div class="income-box"><strong>Invite bonus</strong><p id="videoIncome">Rs 0</p></div>
      </div>
    </div>
  </div>

  <div class="info-card">
    <h3><em>LEVEL 1</em></h3>
    <div class="info-grid">
      <p>Level Size<br><strong id="levelSize">0 Friends</strong></p>
      <p>Active Friends<br><strong id="activeFriends">0 Friends</strong></p>
    </div>
    <div class="info-grid">
      <p>Withdrawal<br><strong id="withdrawalCount">0 Friends</strong></p>
    </div>
    <hr class="hr">
    <p class="highlight">
      Invite a friend you will GET: <span>20% Reward</span>
    </p>
  </div>

  <div class="notification-box">
    <img class="notification-image" src="/logo.png" alt="icon">
    <div class="notification-text">
      Invite friends to join Video Watcher, you will get
      <span class="highlight">20% Reward</span> for each person you join,
      <a href="invite.html">go invite friends ></a>
    </div>
  </div>

  <!-- ✅ Referred Users Section -->
  <div class="ref-list" id="refListBox" style="display: none;">
    <h3>Your Referred Users</h3>
    <div id="refUsers">Loading...</div>
  </div>

  <a href="https://whatsapp.com/channel/0029Vb62XUS3wtbDKgcVe41q" target="_blank" class="whatsapp-button">
    <img src="/whatsapp.png" alt="Join WhatsApp Channel" />
  </a>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="index.html"><i class="fas fa-home"></i>Home</a>
    <a href="task.html"><i class="fas fa-tasks"></i>Tasks</a>
    <a href="invite.html"><i class="fas fa-user-plus"></i>Invite</a>
    <a href="team.html" class="active"><i class="fas fa-users"></i>Team</a>
    <a href="me.html"><i class="fas fa-user"></i>Me</a>
  </div>

  <!-- ✅ Firebase Modular Firestore Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyAjC2opLqcaaRACpT_FcrnOsysH-7E7PK8",
    authDomain: "referral-id-3772a.firebaseapp.com",
    projectId: "referral-id-3772a",
    storageBucket: "referral-id-3772a.firebasestorage.app",
    messagingSenderId: "74576834293",
    appId: "1:74576834293:web:4a3e35b1f3ba2d78b61fbc",
    measurementId: "G-EELB1J45HD"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const referralCode = localStorage.getItem("referral_code");
  
  const refUsersDiv = document.getElementById("refUsers");
  const refListBox = document.getElementById("refListBox");
  
  if (referralCode) {
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("referralBy", "==", referralCode), orderBy("createdAt", "desc"));
    getDocs(q)
      .then(snapshot => {
        if (snapshot.empty) {
          refListBox.style.display = "none";
        } else {
          refListBox.style.display = "block";
          let html = "";
          let totalTeamBonus = 0;
          let inviteBonus = 0;
          
          let levelSize = 0;
          let activeFriends = 0;
          let withdrawalCount = 0;
          
          snapshot.forEach(doc => {
            const data = doc.data();
            const date = data.createdAt?.toDate().toISOString().split("T")[0] || "Unknown";
            const userId = data.referralCode || data.uid || "xyz123";
            
            const videoTaskDone = data.videoTaskCompleted === true;
            const adsTaskDone = data.adsTaskCompleted === true;
            const hasWithdrawn = data.withdrawalDone === true;
            
            levelSize++;
            if (videoTaskDone || adsTaskDone) activeFriends++;
            if (hasWithdrawn) withdrawalCount++;
            
            let userBonus = 0;
            if (videoTaskDone) userBonus += 1;
            if (adsTaskDone) userBonus += 1;
            
            totalTeamBonus += userBonus;
            inviteBonus += userBonus * 0.2;
            
            html += `
              <div class="ref-user">
                <div class="date">${date}</div>
                <div class="id">ID: ${userId}</div>
                <table>
                  <thead>
                    <tr>
                      <th>Video Watcher</th>
                      <th>Bonus</th>
                      <th>Active</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Video Task</td>
                      <td>Rs ${videoTaskDone ? '1' : '0'}</td>
                      <td><span class="tick-circle ${videoTaskDone ? 'completed' : ''}">✔</span></td>
                    </tr>
                    <tr>
                      <td>Ads Task</td>
                      <td>Rs ${adsTaskDone ? '1' : '0'}</td>
                      <td><span class="tick-circle ${adsTaskDone ? 'completed' : ''}">✔</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            `;
          });
          
          refUsersDiv.innerHTML = html;
          document.getElementById("totalIncome").textContent = `Rs ${totalTeamBonus}`;
          document.getElementById("videoIncome").textContent = `Rs ${inviteBonus.toFixed(2)}`;
          document.getElementById("levelSize").textContent = `${levelSize} Friends`;
          document.getElementById("activeFriends").textContent = `${activeFriends} Friends`;
          document.getElementById("withdrawalCount").textContent = `${withdrawalCount} Friends`;
        }
      })
      .catch(err => {
        console.error("Fetch error:", err);
        refListBox.style.display = "none";
      });
  } else {
    refListBox.style.display = "none";
  }
</script>
</body>
</html>
