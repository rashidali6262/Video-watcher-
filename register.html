<!DOCTYPE html>
<html lang="en">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
  <title>Register</title>  
  <style>  
    * {
      font-family: 'Georgia', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {  
      font-family: 'Georgia';  
      background-color:#A80D32;  
      direction: ltr;  
    }
    .header-bar {  
      position: fixed;  
      top: 0;  
      left: 0;  
      width: 100%;  
      background-color: #ccc;  
      color: #5965A4;  
      text-align: center;  
      font-size: 1.5em;  
      font-weight: 400;  
      margin: 0;  
      padding: 5px 0;  
      z-index: 1000;  
    }
    .back-button {
      position: absolute;
      left: -130px;
      top: -6px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #5965A4;
      -webkit-tap-highlight-color: transparent
    }
    .container {  
      max-width: 400px;  
      margin-top: 60px;  
      background: white;  
      padding: 20px;  
      border-radius: 6px;  
    }
    .banner-image {  
      width: 70%;  
      border-radius: 10px;  
      margin-left: 15%;  
    }
    h2 {  
      text-align: center;  
      margin-bottom: 20px;  
    }
    .referral-text {  
      text-align: center;  
      color: #888;  
      font-weight: bold;  
      margin-bottom: 20px;  
    }
    .signup-link {  
      color: #007BFF;  
      text-decoration: none;  
    }
    label {  
      display: block;  
      margin-top: 15px;  
    }
    .password-wrapper {  
      position: relative;  
      width: 100%;  
    }
    .eye-icon {  
      position: absolute;  
      top: 57%;  
      right: 10px;  
      width: 24px;  
      height: 24px;  
      transform: translateY(-50%);  
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;  
    }
    input, select, button {  
      width: 100%;  
      padding: 10px;  
      margin-top: 5px;  
      margin-left: -10px;  
      border: 1px solid #ccc;  
      border-radius: 5px;  
      background: #D1D2DD;  
    }
    input:focus,
    select:focus {
      outline: none;
      border: 1px solid #ccc;
    }
    #registerBtn {  
      background-color: #888;  
      color: white;  
      border: none;  
      margin: 20px auto 0 auto;  
      cursor: not-allowed;  
      width: 200px;  
      display: block;  
    }
    #registerBtn.enabled {  
      background-color: #A80D32;  
      cursor: pointer;  
    }
    .info {  
      margin-top: 10px;  
      font-size: 0.9em;  
      color: #0C6FFF;  
      text-align: center;  
    }
    .bottom-line {  
      margin-top: 20px;  
      text-align: center;  
      font-size: 0.9em;  
      color: #888;  
      border-top: 1px solid #ddd;  
      padding-top: 10px;  
      -webkit-tap-highlight-color: transparent;  
    }
    .flex-row {  
      display: flex;  
      width: 315px;  
      gap: 10px;  
    }
    .flex-row input {  
      flex: 1;  
    }
    .flex-row button {  
      flex: 0 0 87px;  
      margin-left: 227.8px;  
      margin-top: 5.88px;  
      position: absolute;  
      width: 85.999px;  
      padding: 9.999px;  
      background: #888;  
      border: none;  
      color: white;  
      cursor: not-allowed;  
    }
    .sendcode.active {  
      background-color: #A80D32 !important;  
      cursor: pointer !important;  
    }
    #passwordError {  
      color: #C71515;  
      font-size: 0.8em;  
      display: none;  
      margin-left: -10px;  
      margin-top: 3px;  
    }  
  </style>  
</head>  
<body>  
  <div class="header-bar">
    <button class="back-button" onclick="history.back()">< Back</button>
    Sign up</div>  
  <div class="container">  
    <img src="/banner.png" alt="Banner" class="banner-image" />  
    <h2>Create new Account</h2>  

    <div id="referralSection" style="display: none;">  
      <p class="referral-text">Referral ID: <span id="refText"></span></p>  
      <input type="hidden" id="referralInput" name="referral" />  
    </div>  

    <label for="country">Select Country</label>  
    <select id="country">  
      <option value="" selected disabled>Select Country</option>  
      <option value="PK">Pakistan</option>  
    </select>  

    <label for="email">Email</label>  
    <input type="email" id="email" placeholder="@gmail.com" />  

    <label for="password">Password</label>  
    <div class="password-wrapper">  
      <input type="password" id="password" placeholder="Enter password" />  
      <img src="/eye1.png" id="togglePassword" class="eye-icon" />  
    </div>  

    <label for="confirmPassword">Confirm Password</label>  
    <div class="password-wrapper">  
      <input type="password" id="confirmPassword" placeholder="Confirm password" />  
      <img src="/eye1.png" id="toggleConfirmPassword" class="eye-icon" />  
    </div>  

    <div id="passwordError">Password must be at least 6 characters</div>  

    <label for="verificationCode">Email Verification Code</label>  
    <div class="flex-row">  
      <input type="text" id="verificationCode" placeholder="Enter verification code" />  
      <button type="button" class="sendcode" id="sendCodeBtn" disabled>Send Code</button>  
    </div>  

    <div class="info">Verification code will be sent to your Gmail.</div>  
    <button id="registerBtn" disabled>Register</button>  

    <div class="bottom-line">  
      Already have an account? <a href="login.html" class="signup-link">Login</a>  
    </div>  
  </div>  

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("4olTZxiOxAHKbysTd");
</script>

<script type="module">
  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
  
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAjC2opLqcaaRACpT_FcrnOsysH-7E7PK8",
    authDomain: "referral-id-3772a.firebaseapp.com",
    projectId: "referral-id-3772a",
    storageBucket: "referral-id-3772a.appspot.com",
    messagingSenderId: "74576834293",
    appId: "1:74576834293:web:4a3e35b1f3ba2d78b61fbc",
    measurementId: "G-EELB1J45HD"
  };
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  // ðŸ”’ Prevent access to register page if already logged in
  onAuthStateChanged(auth, (user) => {
    if (user) {
      window.location.replace("index.html");
    }
  });
  
  // Referral ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const referralCode = urlParams.get('ref');
  
  // Form and Inputs
  const form = document.querySelector("form");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const confirmPasswordInput = document.getElementById("confirmPassword");
  const verificationCodeInput = document.getElementById("verificationCode");
  const sendCodeButton = document.getElementById("sendCode");
  const submitBtn = document.querySelector("button[type='submit']");
  const messageBox = document.getElementById("message");
  
  let generatedCode = "";
  
  // Send verification code
  sendCodeButton.addEventListener("click", function() {
    const email = emailInput.value.trim();
    if (!email) {
      alert("Please enter your email before sending the code.");
      return;
    }
    
    generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
    
    emailjs.send("service_j1sks8o", "template_fsz8tli", {
        to_email: email,
        code: generatedCode
      }, "L4DF8m1e0o4yIB2uh")
      .then(() => {
        alert("Verification code sent to your email.");
        let seconds = 120;
        sendCodeButton.disabled = true;
        sendCodeButton.innerText = `Wait (${seconds}s)`;
        const interval = setInterval(() => {
          seconds--;
          sendCodeButton.innerText = `Wait (${seconds}s)`;
          if (seconds <= 0) {
            clearInterval(interval);
            sendCodeButton.disabled = false;
            sendCodeButton.innerText = "Send Code";
          }
        }, 1000);
      })
      .catch((error) => {
        console.error("EmailJS Error:", error);
        alert("Failed to send code. Please try again.");
      });
  });
  
  // Form submit
  form.addEventListener("submit", function(e) {
    e.preventDefault();
    
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const confirmPassword = confirmPasswordInput.value.trim();
    const enteredCode = verificationCodeInput.value.trim();
    
    if (password !== confirmPassword) {
      alert("Passwords do not match.");
      return;
    }
    
    if (enteredCode !== generatedCode) {
      alert("Invalid verification code.");
      return;
    }
    
    createUserWithEmailAndPassword(auth, email, password)
      .then(async (userCredential) => {
        const user = userCredential.user;
        await sendEmailVerification(user);
        
        const uid = user.uid;
        const refCode = uid.slice(0, 6); // unique referral ID
        localStorage.setItem("referralCode", refCode);
        localStorage.setItem("email", email);
        
        // Save to Firestore
        await setDoc(doc(db, "users", uid), {
          email: email,
          referralCode: refCode,
          referredBy: referralCode || null,
          createdAt: new Date().toISOString()
        });
        
        alert("Registration successful. Redirecting to home...");
        window.location.replace("index.html");
      })
      .catch((error) => {
        console.error("Registration error:", error);
        alert("Registration failed: " + error.message);
      });
  });
          </script>
</body>  
    </html>
